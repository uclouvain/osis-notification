(function(p,e){typeof exports=="object"&&typeof module<"u"?e(require("@vue/runtime-dom"),require("vue"),require("vue-i18n")):typeof define=="function"&&define.amd?define(["@vue/runtime-dom","vue","vue-i18n"],e):(p=typeof globalThis<"u"?globalThis:p||self,e(p.Vue,p.Vue,p.VueI18n))})(this,function(p,e,R){"use strict";function L(t,n,i){var o={},h="",w="...",g=10>n?n:10,l=["img","br"],T=[],_=0,c=h,C='([\\w|-]+\\s*(=\\s*"[^"]*")?\\s*)*',S="\\s*\\/?\\s*",rt="\\s*\\/\\s*",lt=new RegExp("<\\/?\\w+\\s*"+C+rt+">"),dt=new RegExp("<\\/?\\w+\\s*"+C+S+">"),$=/(((ftp|https?):\/\/)[\-\w@:%_\+.~#?,&\/\/=]+)|((mailto:)?[_.\w\-]+@([\w][\w\-]+\.)+[a-zA-Z]{2,3})/g,ct=new RegExp("<img\\s*"+C+S+">"),ut=new RegExp("\\W+","g"),d=!0,f,m,B,k;function ft(r){var s=ct.exec(r),a,u;return s?(a=s.index,u=s[0].length,r.substring(0,a)+r.substring(a+u)):r}function mt(r){var s="";return r.reverse().forEach(function(a,u){l.indexOf(a)===-1&&(s+="</"+a+">")}),s}function pt(r){var s=r.indexOf(" ");if(s===-1&&(s=r.indexOf(">"),s===-1))throw new Error("HTML tag is not well-formed : "+r);return r.substring(1,s)}function V(r,s){var a=n-_,u=a,A=a<i.slop,y=A?a:i.slop-1,b,ht=A?0:a-i.slop,gt=s||a+i.slop,E;if(!i.truncateLastWord){if(b=r.slice(ht,gt),s&&b.length<=s)u=b.length;else for(;(E=ut.exec(b))!==null;)if(E.index<y){if(u=a-(y-E.index),E.index===0&&a<=1)break}else if(E.index===y){u=a;break}else{u=a+(E.index-y);break}r.charAt(u-1).match(/\s$/)&&u--}return u}for(i=i||o,i.ellipsis=i.ellipsis!==void 0?i.ellipsis:w,i.truncateLastWord=i.truncateLastWord!==void 0?i.truncateLastWord:!0,i.slop=i.slop!==void 0?i.slop:g;d;){if(d=dt.exec(t),!d){if(_>=n)break;if(d=$.exec(t),!d||d.index>=n){c+=t.substring(0,V(t));break}for(;d;)f=d[0],m=d.index,c+=t.substring(0,m+f.length-_),t=t.substring(m+f.length),d=$.exec(t);break}if(f=d[0],m=d.index,_+m>n){c+=t.substring(0,V(t,m));break}else _+=m,c+=t.substring(0,m);f[1]==="/"?(T.pop(),k=null):(k=lt.exec(f),k||(B=pt(f),T.push(B))),k?c+=k[0]:c+=f,t=t.substring(m+f.length)}return t.length>n-_&&i.ellipsis&&(c+=i.ellipsis),c+=mt(T),i.keepImageTag||(c=ft(c)),c}var M=L;const q=e.defineComponent({name:"TruncateHtml",props:{htmlText:{type:String,default:""},length:{type:Number,default:100},lessButtonText:{type:String,default:"Show less"},contentCssClass:{type:String,default:""},containerCssClass:{type:String,default:""},buttonCssClass:{type:String,default:""},moreButtonText:{type:String,default:"Show more"}},data(){return{isTruncated:!0,truncatedHtml:M(this.htmlText,this.length)}}}),N=(t,n)=>{const i=t.__vccOpts||t;for(const[o,h]of n)i[o]=h;return i},G=["innerHTML"];function I(t,n,i,o,h,w){return e.openBlock(),e.createElementBlock("div",{class:e.normalizeClass(t.containerCssClass)},[e.createElementVNode("div",{class:e.normalizeClass([t.isTruncated?"truncated":"",t.contentCssClass]),innerHTML:t.isTruncated?t.truncatedHtml:t.htmlText},null,10,G),t.truncatedHtml.length<t.htmlText.length?(e.openBlock(),e.createElementBlock("button",{key:0,class:e.normalizeClass(t.buttonCssClass),onClick:n[0]||(n[0]=e.withModifiers(g=>t.isTruncated=!t.isTruncated,["prevent"]))},e.toDisplayString(t.isTruncated?t.moreButtonText:t.lessButtonText),3)):e.createCommentVNode("",!0)],2)}const U=N(q,[["render",I]]),D=e.defineComponent({name:"NotificationEntry",components:{TruncateHtml:U},props:{uuid:{type:String,required:!0},state:{type:String,required:!0},sentAt:{type:String,required:!0},payload:{type:String,required:!0},truncateLength:{type:Number,default:60}},emits:["toggle"],computed:{isSent:function(){return this.state==="SENT_STATE"}},mounted(){window.jQuery('[data-toggle="tooltip"]').tooltip({trigger:"hover",placement:"top",container:"body",template:'<div class="tooltip tooltip-notification" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'})},updated(){window.jQuery(`#notification-${this.uuid}`).tooltip("hide")},beforeUnmount(){window.jQuery(`#notification-${this.uuid}`).tooltip("destroy")}}),_t="",H={class:"notification-dropdown-item"},P=["id","checked","data-original-title"],O={class:"label label-primary"};function z(t,n,i,o,h,w){const g=e.resolveComponent("TruncateHtml");return e.openBlock(),e.createElementBlock("li",H,[e.createElementVNode("input",{id:`notification-${t.uuid}`,checked:t.isSent,type:"radio","data-toggle":"tooltip","data-original-title":t.isSent?t.$t("notification.mark_as_read"):t.$t("notification.mark_as_unread"),onClick:n[0]||(n[0]=e.withModifiers(l=>t.$emit("toggle",t.uuid),["prevent"]))},null,8,P),e.createElementVNode("span",O,e.toDisplayString(t.sentAt),1),e.createVNode(g,{"button-css-class":"btn btn-link","container-css-class":"notification-text","content-css-class":t.isSent?"font-bold":"","html-text":t.payload,length:t.truncateLength,"less-button-text":t.$t("notification.show_less"),"more-button-text":t.$t("notification.show_more")},null,8,["content-css-class","html-text","length","less-button-text","more-button-text"])])}const X=N(D,[["render",z]]);function F(t){if(document.cookie){const n=document.cookie.split(";");for(let i=0;i<n.length;i++){const o=n[i].trim();if(o.substring(0,t.length+1)===t+"=")return decodeURIComponent(o.substring(t.length+1))}}throw new Error(`No such cookie ${t}`)}const j=e.defineComponent({name:"NotificationViewer",components:{NotificationEntry:X},props:{baseUrl:{type:String,required:!0},interval:{type:Number,default:300},limit:{type:Number,default:15},truncateLength:{type:Number,default:60}},data(){return{notifications:[],hasNextPage:!1,animationEnabled:!1,pageSize:this.limit,error:"",loading:!0,unreadNotificationsCount:0,timer:0,csrfToken:F("csrftoken")}},unmounted(){window.clearTimeout(this.timer)},mounted(){this.fetchNotifications(),jQuery(document).on("click.bs.dropdown.data-api",".notification-dropdown",t=>t.stopPropagation())},methods:{fetchNotifications:async function(){const t=await this.doRequest(`?limit=${this.pageSize}`,{},!0);t&&(t.unread_count&&(this.animationEnabled=!0),this.notifications=t.results,this.hasNextPage=!!t.next,this.unreadNotificationsCount=t.unread_count,this.timer=window.setTimeout(()=>void this.fetchNotifications(),this.interval*1e3))},toggleState:async function(t){const n=await this.doRequest(t,{method:"PATCH"});if(!n)return;const i=this.notifications.findIndex(o=>o.uuid===t);this.notifications[i]=n,n.state==="SENT_STATE"?this.unreadNotificationsCount++:this.unreadNotificationsCount--,this.notifications.filter(o=>o.state==="SENT_STATE").length!==this.unreadNotificationsCount&&await this.fetchNotifications()},markAllAsRead:async function(){const t=await this.doRequest("mark_all_as_read",{method:"PUT"});t&&t.length>0&&(this.notifications.forEach(n=>n.state="READ_STATE"),this.unreadNotificationsCount=0)},loadMore:async function(t){t.stopPropagation(),this.loading=!0,this.pageSize+=this.limit,await this.fetchNotifications()},doRequest:async function(t,n,i=!1){i&&(this.loading=!0);try{const o=await fetch(`${this.baseUrl}${t}`,{mode:"same-origin",headers:{"Content-Type":"application/json;charset=utf-8","X-CSRFToken":this.csrfToken},...n});if(o.status>=200&&o.status<300)return i&&(this.loading=!1),o.json();this.error=`${this.$t("notification_viewer.error")}  (${o.statusText})`}catch(o){this.error=`${this.$t("notification_viewer.error")} (${o.message})`}i&&(this.loading=!1)}}}),Et="",W=["data-count"],Q=[e.createElementVNode("span",{class:"fas fa-bell"},null,-1)],Y={class:"dropdown-menu notification-dropdown"},x={key:0,class:"progress"},K={class:"progress-bar progress-bar-striped active",role:"progressbar","aria-valuenow":"100","aria-valuemin":"0","aria-valuemax":"100",style:{width:"100%"}},J={class:"sr-only"},Z=e.createElementVNode("li",{role:"separator",class:"divider"},null,-1),v={class:"alert alert-warning",role:"alert"},tt={key:2},et=e.createElementVNode("li",{role:"separator",class:"divider"},null,-1),nt={key:0,class:"text-center"};function it(t,n,i,o,h,w){const g=e.resolveComponent("NotificationEntry");return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("a",{class:"dropdown-toggle","data-toggle":"dropdown",role:"button","aria-haspopup":"true","aria-expanded":"false",onClick:n[0]||(n[0]=l=>t.animationEnabled=!1)},[e.createElementVNode("div",{class:e.normalizeClass(["bell",{"show-count":t.unreadNotificationsCount,notify:t.unreadNotificationsCount&&t.animationEnabled}]),"data-count":t.unreadNotificationsCount},Q,10,W)]),e.createElementVNode("ul",Y,[t.loading?(e.openBlock(),e.createElementBlock("li",x,[e.createElementVNode("div",K,[e.createElementVNode("span",J,e.toDisplayString(t.$t("notification_viewer.loading")),1)])])):t.error?(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[Z,e.createElementVNode("li",null,[e.createElementVNode("div",v,e.toDisplayString(t.error),1)])],64)):e.createCommentVNode("",!0),t.notifications.length?(e.openBlock(),e.createElementBlock(e.Fragment,{key:3},[e.createElementVNode("li",null,[e.createElementVNode("a",{class:e.normalizeClass(["btn",{disabled:!t.unreadNotificationsCount}]),onClick:n[1]||(n[1]=(...l)=>t.markAllAsRead&&t.markAllAsRead(...l))},e.toDisplayString(t.$t("notification_viewer.mark_all_as_read")),3)]),et,(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.notifications,l=>(e.openBlock(),e.createBlock(g,{key:l.uuid,uuid:l.uuid,state:l.state,"sent-at":l.sent_at,payload:l.payload,"truncate-length":t.truncateLength,onToggle:t.toggleState},null,8,["uuid","state","sent-at","payload","truncate-length","onToggle"]))),128)),t.hasNextPage?(e.openBlock(),e.createElementBlock("li",nt,[e.createElementVNode("button",{type:"button",class:"btn btn-link",onClick:n[2]||(n[2]=(...l)=>t.loadMore&&t.loadMore(...l))},e.toDisplayString(t.$t("notification_viewer.load_more")),1)])):e.createCommentVNode("",!0)],64)):(e.openBlock(),e.createElementBlock("li",tt,e.toDisplayString(t.$t("notification_viewer.no_notifications")),1))])],64)}const ot=N(j,[["render",it]]),at={en:{notification_viewer:{mark_all_as_read:"Mark all as read",error:"An error occurred, please try again later.",load_more:"Load more",loading:"Loading...",no_notifications:"No notifications."},notification:{mark_as_read:"Mark as read",mark_as_unread:"Mark as unread",show_less:"Show less",show_more:"Show more"}},"fr-be":{notification_viewer:{mark_all_as_read:"Tout marquer comme lu",error:"Une erreur s'est produite, veuillez réessayer plus tard.",load_more:"Afficher plus",loading:"Chargement...",no_notifications:"Pas de notifications."},notification:{mark_as_read:"Marquer comme lu",mark_as_unread:"Marquer comme non-lu",show_less:"Voir moins",show_more:"Voir plus"}}},st=R.createI18n({locale:document.documentElement.lang||"en",messages:at});document.querySelectorAll("#notification-viewer").forEach(t=>{const n={baseUrl:"",...t.dataset};t.dataset.interval&&(n.interval=Number.parseInt(t.dataset.interval)),t.dataset.limit&&(n.limit=Number.parseInt(t.dataset.limit)),t.dataset.truncateLength&&(n.truncateLength=Number.parseInt(t.dataset.truncateLength)),p.createApp(ot,n).use(st).mount(t)})});
//# sourceMappingURL=osis-notification.umd.min.js.map
